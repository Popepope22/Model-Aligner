
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Model–Revenue Aligner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <style>
    .badge{ display:inline-flex; align-items:center; padding:2px 8px; border-radius:9999px; font-size:12px; font-weight:600 }
    .badge.exact{ background:#d1fae5; color:#065f46 }     /* emerald */
    .badge.alias{ background:#e0e7ff; color:#3730a3 }     /* indigo */
    .badge.fuzzy{ background:#fef3c7; color:#92400e }     /* amber  */
    .badge.missing{ background:#ffe4e6; color:#9f1239 }   /* rose   */
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Model–Revenue Aligner</h1>
      <div class="text-sm text-slate-500">Paste your model order & raw revenue. Click <span class="font-semibold">Align</span>.</div>
    </header>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl shadow p-4 space-y-3">
        <h2 class="font-semibold">Model List (Order to Keep)</h2>
        <textarea id="models" rows="16" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500 p-3 font-mono text-sm" placeholder="One model per line..."></textarea>
        <p class="text-xs text-slate-500">We keep this exact order. No alphabetizing.</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 space-y-3">
        <h2 class="font-semibold">Revenue List (Raw)</h2>
        <textarea id="revenue" rows="16" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500 p-3 font-mono text-sm" placeholder="Examples:
Ali - $1576.23
Chelsea Wilde - $239.15
Blink VIP - $1009.72
@handles are fine; we'll strip them..."></textarea>
        <p class="text-xs text-slate-500">Aliases & fuzzy matching are supported (see below).</p>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow p-4 space-y-3">
      <div class="flex items-center gap-3">
        <h2 class="font-semibold">Alias Mapping (Optional)</h2>
        <span class="text-xs text-slate-500">Left = name in your model list → Right = name as it appears in revenue list</span>
      </div>
      <textarea id="aliases" rows="20" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500 p-3 font-mono text-sm">
{
  "ali": "ali",
  "ali free": "ali free",
  "ali smiles": "ali smiles",
  "ali smiles free": "ali smiles free",
  "amber": "amber",
  "asteria": "asteria",
  "blink vip": "blink vip",
  "blinkx": "blinkx",
  "blinkx fansly": "blinkx fansly",
  "chelsea free": "chelsea free",
  "chelsea wilde": "chelsea wilde",
  "clarus": "clarus",
  "clarus free": "clarus free",
  "cora": "cora",
  "dallas": "dallas",
  "darcie": "darcie",
  "darshelle free": "darshelle free",
  "darshelle vip": "darshelle main",
  "davina": "davina",
  "davina free": "davina free",
  "evie free": "evie free",
  "evie rose": "evie rose",
  "florence": "florence",
  "frizzy": "frizzy",
  "heidi free": "heidi free",
  "heidi vip": "heidi vip",
  "holly free": "holly free",
  "holly oftv": "holly oftv",
  "holly vip": "holly vip",
  "jay": "jay",
  "jay free": "jay free",
  "jenn": "jenn",
  "julie free": "julie free",
  "julie vip": "julie vip",
  "kailyn free": "kailyn free",
  "kailyn vip": "kailyn vip",
  "kay free": "kay free",
  "kay": "kay natrix",
  "lauren": "lauren",
  "lauren free": "lauren free",
  "lilly hart": "lilly hart",
  "lillyhart": "lilly hart",
  "luna": "luna",
  "margs free": "margs free",
  "margs vip": "margs vip",
  "miko": "miko",
  "miko free": "miko free",
  "morgan": "morgan",
  "morgan free": "morgan free",
  "mystic free": "mystic free",
  "mystic vip": "mystic vip",
  "mysticbeing": "mysticbeing",
  "mythiccal": "mythiccal",
  "mythiccal free": "mythiccal",
  "mythiccal vip": "mythiccal vip",
  "nichole free": "nichole free",
  "nichole vip": "nichole vip",
  "reed": "reed",
  "river": "river",
  "roxie free": "roxie free",
  "roxie vip": "roxie sinner",
  "saffron tiffy": "saffron tiffy",
  "saffron vip": "saffron vip",
  "sam free": "sam free",
  "sam vip": "sam vip",
  "sarah arabic": "sarah arabic",
  "savannah": "savannah",
  "savannah free": "savannah free",
  "scarlett": "scarlett",
  "taaij": "taaij",
  "tabitha": "tabitha",
  "tayla": "tayla",
  "valeria": "valeria",
  "veronica": "veronica",
  "zalia": "zalia"
}
      </textarea>
      <div class="text-xs text-slate-500">
        Tip: Paste JSON only for the day. If you leave it empty, only exact/fuzzy matches are used.
      </div>
    </section>

    <section class="flex flex-wrap items-center gap-3">
      <button id="btnAlign" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium shadow hover:bg-indigo-700">Align</button>
      <button id="btnCopyPlain" class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-800 shadow">Copy Plain Column</button>
      <button id="btnCopyValues" class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-800 shadow">Copy Values</button>
      <button id="btnDownloadCsv" class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-800 shadow">Download CSV</button>
      <span id="sumOut" class="ml-auto text-sm text-slate-600"></span>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl shadow p-4 space-y-3">
        <div class="flex items-center gap-2">
          <h2 class="font-semibold">Aligned Output (Plain Column)</h2>
          <span id="statusCount" class="text-xs text-slate-500"></span>
        </div>
        <pre id="plainOut" class="whitespace-pre-wrap break-words font-mono text-sm bg-slate-50 rounded-xl p-3 min-h-[200px]"></pre>
        <div class="space-y-2">
          <h3 class="font-semibold">Values Only</h3>
          <pre id="valuesOut" class="whitespace-pre-wrap break-words font-mono text-sm bg-slate-50 rounded-xl p-3 min-h-[120px]"></pre>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 space-y-3">
        <div class="flex items-center gap-2">
          <h2 class="font-semibold">Match Report</h2>
          <span class="text-xs text-slate-500">How each line was matched</span>
        </div>
        <div id="report" class="space-y-2 text-sm"></div>
      </div>
    </section>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const money = (n) => isFinite(n) ? `$${Number(n).toFixed(2)}` : 'N/A';

    function parseLines(text){
      return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }

    function normalizeName(s){
      return s
        .toLowerCase()
        .replace(/\(\s*new\s*\)/ig,'')
        .replace(/\s+/g,' ')
        .replace(/[–—]/g,'-')
        .trim();
    }

    function parseRevenueMap(text){
      const lines = parseLines(text);
      const map = {};
      for(const line of lines){
        const m = line.match(/\$\s*([0-9]{1,3}(?:,[0-9]{3})*(?:\.[0-9]{1,2})?|[0-9]+(?:\.[0-9]{1,2})?)/);
        if(!m) continue;
        const amt = parseFloat(m[1].replace(/,/g,''));
        let name = line.split(' - ')[0];
        if(!name || name.includes('$')){
          name = line.replace(/\$.*$/, '').trim();
        }
        name = name.replace(/\s*-\s*@.*$/,''); // remove trailing handle after dash
        name = name.replace(/\s*@.+$/,'');      // remove trailing @handle
        name = normalizeName(name);
        map[name] = amt;
      }
      return map;
    }

    // defaultAliases is empty here — all aliases come from textarea prefilled
    const defaultAliases = {};

    function makeFuser(keys){
      return new Fuse(keys, { includeScore:true, threshold:0.25, ignoreLocation:true, distance:40 });
    }

    function align(){
      const modelsRaw = parseLines($('#models').value);
      const models = modelsRaw.map(normalizeName);
      const revenueMap = parseRevenueMap($('#revenue').value);

      let userAliases = {};
      try {
        const raw = $('#aliases').value.trim();
        if(raw){
          const parsed = JSON.parse(raw);
          userAliases = {};
          for(const [k,v] of Object.entries(parsed)){
            userAliases[normalizeName(k)] = normalizeName(v);
          }
        }
      } catch(e){
        alert('Alias JSON is invalid. Please fix.');
        return;
      }

      const alias = { ...defaultAliases, ...userAliases };

      const revenueKeys = Object.keys(revenueMap);
      const fuser = makeFuser(revenueKeys);

      const rows = [];
      let total = 0;
      let counts = {exact:0, alias:0, fuzzy:0, missing:0};

      for(let i=0; i<models.length; i++){
        const model = models[i];
        const origModel = modelsRaw[i]; // preserve original casing for output
        let key = model;
        let method = 'exact';

        if(alias[model]){
          key = alias[model];
          method = 'alias';
        }

        let amt = revenueMap[key];

        if(amt === undefined){
          const tryNames = [key, model];
          let best = null;
          for(const t of tryNames){
            const r = fuser.search(t);
            if(r && r.length){
              const hit = r[0];
              if(!best || hit.score < best.score) best = hit;
            }
          }
          if(best && best.score <= 0.12){
            key = best.item;
            amt = revenueMap[key];
            method = method === 'alias' ? 'alias+fuzzy' : 'fuzzy';
          }
        }

        if(amt === undefined){
          rows.push({model:origModel, key:'', amount:NaN, method:'missing'});
          counts.missing++;
        } else {
          total += amt;
          if(method==='exact') counts.exact++; else if(method.includes('alias')) counts.alias++; else counts.fuzzy++;
          rows.push({model:origModel, key, amount:amt, method});
        }
      }

      const plain = rows.map(r => `${r.model} - ${isNaN(r.amount)?'N/A':money(r.amount)}`).join('\n');
      $('#plainOut').textContent = plain;

      const valuesOnly = rows.map(r => isNaN(r.amount) ? 'N/A' : money(r.amount)).join('\n');
      $('#valuesOut').textContent = valuesOnly;

      $('#sumOut').textContent = `Total = ${money(total)}`;
      $('#statusCount').textContent = `Exact ${counts.exact} · Alias ${counts.alias} · Fuzzy ${counts.fuzzy} · Missing ${counts.missing}`;

      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between gap-2 border border-slate-200 rounded-lg px-3 py-2';
        const left = document.createElement('div');
        left.innerHTML = `<span class="font-semibold">${r.model}</span>` + (r.key?` <span class="text-slate-400">→</span> <span class="text-slate-600">${r.key}</span>`:'');
        const right = document.createElement('div');
        const badge = document.createElement('span');
        badge.className = 'badge ' + (r.method==='exact'?'exact': r.method.includes('alias')?'alias': r.method==='fuzzy'?'fuzzy':'missing');
        badge.textContent = r.method;
        const amt = document.createElement('span');
        amt.className = 'ml-3 font-mono';
        amt.textContent = isNaN(r.amount)?'N/A':money(r.amount);
        right.appendChild(badge); right.appendChild(amt);
        div.appendChild(left); div.appendChild(right);
        frag.appendChild(div);
      });
      const report = $('#report');
      report.innerHTML = ''; report.appendChild(frag);

      localStorage.setItem('mra_models', $('#models').value);
      localStorage.setItem('mra_revenue', $('#revenue').value);
      localStorage.setItem('mra_alias', $('#aliases').value);
    }

    function copyPlain(){
      const text = $('#plainOut').textContent;
      if(!text.trim()) return;
      navigator.clipboard.writeText(text).then(()=>alert('Copied aligned column to clipboard'));
    }
    function copyValues(){
      const text = $('#valuesOut').textContent;
      if(!text.trim()) return;
      navigator.clipboard.writeText(text).then(()=>alert('Copied values-only column to clipboard'));
    }

    function downloadCsv(){
      const lines = $('#plainOut').textContent.split(/\n/).filter(Boolean);
      if(!lines.length) return;
      const rows = lines.map(l=>{
        const m = l.match(/^(.*) - \$(.*)$/);
        if(m) return `${JSON.stringify(m[1])},${m[2]}`;
        return `${JSON.stringify(l)},`;
      });
      const csv = 'Model,Amount\n' + rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'aligned.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const m = localStorage.getItem('mra_models'); if(m) $('#models').value = m;
      const r = localStorage.getItem('mra_revenue'); if(r) $('#revenue').value = r;
      const a = localStorage.getItem('mra_alias'); if(a) $('#aliases').value = a;
    });

    $('#btnAlign').addEventListener('click', align);
    $('#btnCopyPlain').addEventListener('click', copyPlain);
    $('#btnCopyValues').addEventListener('click', copyValues);
    $('#btnDownloadCsv').addEventListener('click', downloadCsv);
  </script>
</body>
</html>
